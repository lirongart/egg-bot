<full pasted code here, shortened for brevity>